{% extends 'base.html' %}

{% block title %}Dashboard - Smart Cabinet{% endblock %}

{% block content %}
<div id="alert-area"></div>
<h1 class="mb-4">Web Dashboard</h1>
<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab">Employees</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">Access Logs</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="door-tab" data-bs-toggle="tab" data-bs-target="#door" type="button" role="tab">Door Status</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="instruments-tab" data-bs-toggle="tab" data-bs-target="#instruments" type="button" role="tab">Instruments</button>
    </li>
</ul>
<div class="tab-content mt-3" id="dashboardTabsContent">
    <div class="tab-pane fade show active" id="employees" role="tabpanel">
        <h3>Employees</h3>
        <button class="btn btn-success mb-3" id="add-employee-btn">Add Employee</button>
        <div id="employees-content">Loading...</div>
    </div>
    <div class="tab-pane fade" id="logs" role="tabpanel">
        <h3>Access Logs</h3>
        <form id="logs-filter-form" class="row g-3 mb-3">
            <div class="col-md-3">
                <input type="text" class="form-control" id="filter-employee-id" placeholder="Employee ID">
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" id="filter-fingerprint-id" placeholder="Fingerprint ID">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filter-status">
                    <option value="">All Statuses</option>
                    <option value="success">Success</option>
                    <option value="failure">Failure</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">Filter</button>
                <button type="button" class="btn btn-secondary ms-2" id="clear-logs-filter">Clear</button>
            </div>
        </form>
        <div id="logs-content">Loading...</div>
    </div>
    <div class="tab-pane fade" id="door" role="tabpanel">
        <h3>Door Status</h3>
        <div id="door-content">Loading...</div>
    </div>
    <div class="tab-pane fade" id="instruments" role="tabpanel">
        <h2>Instruments</h2>
        <button class="btn btn-success mb-3" onclick="showAddInstrumentForm()">Add Instrument</button>
        <div id="add-instrument-form" style="display:none; margin-top:10px;">
            <input type="text" id="new-instrument-name" class="form-control" placeholder="Instrument Name">
            <button class="btn btn-primary mt-2" onclick="addInstrument()">Save</button>
        </div>
        <div id="instruments-table" class="mt-3"></div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Fetch and display employees
function loadEmployees() {
    fetch('/api/employees')
        .then(response => response.json())
        .then(data => {
            let html = '<table class="table table-striped"><thead><tr><th>Fingerprint ID</th><th>Employee ID</th><th>Name</th><th>Actions</th></tr></thead><tbody>';
            data.forEach(emp => {
                html += `<tr><td>${emp.fingerprint_ID}</td><td>${emp.employee_ID}</td><td>${emp.name}</td><td><button class='btn btn-primary btn-sm edit-employee-btn me-2' data-fid='${emp.fingerprint_ID}' data-empid='${emp.employee_ID}' data-name='${emp.name}'>Edit</button><button class='btn btn-danger btn-sm delete-employee-btn' data-fid='${emp.fingerprint_ID}'>Delete</button></td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('employees-content').innerHTML = html;

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-employee-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const fid = this.getAttribute('data-fid');
                    if (confirm('Are you sure you want to delete this employee?')) {
                        fetch(`/api/employees/${fid}`, { method: 'DELETE' })
                            .then(response => response.json())
                            .then(result => {
                                if (result.status === 'success') {
                                    loadEmployees();
                                } else {
                                    alert(result.message || 'Failed to delete employee.');
                                }
                            })
                            .catch(() => alert('Failed to delete employee.'));
                    }
                });
            });

            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-employee-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const fid = this.getAttribute('data-fid');
                    const empid = this.getAttribute('data-empid');
                    const name = this.getAttribute('data-name');
                    document.getElementById('edit-fingerprint-id').value = fid;
                    document.getElementById('edit-employee-id').value = empid;
                    document.getElementById('edit-name').value = name;
                    const editModal = new bootstrap.Modal(document.getElementById('editEmployeeModal'));
                    editModal.show();
                });
            });
        })
        .catch(() => {
            document.getElementById('employees-content').innerHTML = 'Failed to load employees.';
        });
}

// Fetch and display access logs
function loadLogs(filters = {}) {
    let url = '/api/access-logs';
    const params = [];
    if (filters.fingerprint_ID) params.push(`fingerprint_ID=${encodeURIComponent(filters.fingerprint_ID)}`);
    if (filters.employee_ID) params.push(`employee_ID=${encodeURIComponent(filters.employee_ID)}`);
    if (filters.status) params.push(`status=${encodeURIComponent(filters.status)}`);
    if (params.length) url += '?' + params.join('&');
    fetch(url)
        .then(response => response.json())
        .then(data => {
            let html = '<table class="table table-striped"><thead><tr><th>ID</th><th>Fingerprint ID</th><th>Employee ID</th><th>Name</th><th>Status</th><th>Timestamp</th><th>Instrument ID</th><th>Instrument Name</th></tr></thead><tbody>';
            data.forEach(log => {
                html += `<tr><td>${log.id}</td><td>${log.fingerprint_ID}</td><td>${log.employee_ID}</td><td>${log.name}</td><td>${log.status}</td><td>${log.timestamp}</td><td>${log.instrument_id}</td><td>${log.instrument_name}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('logs-content').innerHTML = html;
        })
        .catch(() => {
            document.getElementById('logs-content').innerHTML = 'Failed to load access logs.';
        });
}

// Fetch and display door status
function loadDoorStatus() {
    fetch('/api/door-status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('door-content').innerHTML = `<div class="alert alert-info"><strong>Status:</strong> ${data.status}<br>${data.message}</div>`;
        })
        .catch(() => {
            document.getElementById('door-content').innerHTML = 'Failed to load door status.';
        });
}

// Load data when the page loads and when tabs are shown
window.addEventListener('DOMContentLoaded', () => {
    loadEmployees();
    loadLogs();
    loadDoorStatus();
    loadInstruments(); // Load instruments when the page loads

    // Reload data when switching tabs
    document.getElementById('employees-tab').addEventListener('shown.bs.tab', loadEmployees);
    document.getElementById('logs-tab').addEventListener('shown.bs.tab', loadLogs);
    document.getElementById('door-tab').addEventListener('shown.bs.tab', loadDoorStatus);
    document.getElementById('instruments-tab').addEventListener('shown.bs.tab', loadInstruments); // Reload instruments when switching tabs

    // Filtering for logs
    document.getElementById('logs-filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const filters = {
            employee_ID: document.getElementById('filter-employee-id').value.trim(),
            fingerprint_ID: document.getElementById('filter-fingerprint-id').value.trim(),
            status: document.getElementById('filter-status').value
        };
        loadLogs(filters);
    });
    document.getElementById('clear-logs-filter').addEventListener('click', function() {
        document.getElementById('filter-employee-id').value = '';
        document.getElementById('filter-fingerprint-id').value = '';
        document.getElementById('filter-status').value = '';
        loadLogs();
    });

    // Edit employee form submission
    document.getElementById('edit-employee-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const fid = document.getElementById('edit-fingerprint-id').value;
        const empid = document.getElementById('edit-employee-id').value.trim();
        const name = document.getElementById('edit-name').value.trim();
        fetch(`/api/employees/${fid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ employee_ID: empid, name: name })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal'));
                editModal.hide();
                loadEmployees();
            } else {
                alert(result.message || 'Failed to update employee.');
            }
        })
        .catch(() => alert('Failed to update employee.'));
    });

    // Add Employee button
    document.getElementById('add-employee-btn').addEventListener('click', function() {
        document.getElementById('add-employee-form').reset();
        const addModal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
        addModal.show();
    });
});
// --- Real-time Door Status via SSE ---
const doorContent = document.getElementById('door-content');
const evtSource = new EventSource('/events');
evtSource.onmessage = function(event) {
    if (event.data === 'opened') {
        doorContent.innerHTML = `<div class="alert alert-success"><strong>Status:</strong> Door is <b>OPENED</b></div>`;
    } else if (event.data === 'closed') {
        doorContent.innerHTML = `<div class="alert alert-secondary"><strong>Status:</strong> Door is <b>CLOSED</b></div>`;
    }
};

// --- Real-time Access Log via SSE ---
const logsContent = document.getElementById('logs-content');
const logEvtSource = new EventSource('/events/access-log');
logEvtSource.onmessage = function(event) {
    const log = JSON.parse(event.data);
    // Prepend the new log to the table if it exists, otherwise reload
    if (logsContent && logsContent.querySelector('table')) {
        const row = `<tr>
            <td>${log.id}</td>
            <td>${log.fingerprint_ID}</td>
            <td>${log.employee_ID || ''}</td>
            <td>${log.name || ''}</td>
            <td>${log.status}</td>
            <td>${log.timestamp}</td>
        </tr>`;
        logsContent.querySelector('tbody').insertAdjacentHTML('afterbegin', row);
    } else {
        loadLogs();
    }
};

// --- Real-time Vision Alerts via SSE for dashboard ---
const alertArea = document.getElementById('alert-area');
const visionEvtSource = new EventSource('/events/vision-alert');
let alertHistory = [];
visionEvtSource.onmessage = function(event) {
    const alert = JSON.parse(event.data);
    alertHistory.unshift(alert);
    if (alertHistory.length > 5) alertHistory = alertHistory.slice(0, 5);
    let html = '';
    for (const a of alertHistory) {
        html += `<div class="alert alert-warning"><strong>${a.alert_type}:</strong> ${a.message}`;
        // Only show images if alert_type is 'danger' or 'info'
        if ((a.alert_type === 'danger' || a.alert_type === 'info') && a.frame_urls && a.frame_urls.length > 0) {
            html += '<div class="d-flex flex-wrap mt-2">';
            for (const url of a.frame_urls) {
                html += `<img src="${url}" style="max-width:120px;max-height:90px;margin-right:8px;margin-bottom:8px;">`;
            }
            html += '</div>';
        }
        html += '</div>';
    }
    alertArea.innerHTML = html;
};

function loadInstruments() {
  fetch('/api/instruments')
    .then(response => response.json())
    .then(data => {
      let html = '<table class="table table-striped"><thead><tr><th>ID</th><th>Name</th><th>Status</th></tr></thead><tbody>';
      data.forEach(inst => {
        html += `<tr><td>${inst.id}</td><td>${inst.name}</td><td>${inst.status}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('instruments-table').innerHTML = html;
    });
}

function showAddInstrumentForm() {
  document.getElementById('add-instrument-form').style.display = 'block';
}

function addInstrument() {
  const name = document.getElementById('new-instrument-name').value;
  fetch('/api/instruments', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name: name, status: 'available'})
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      loadInstruments();
      document.getElementById('add-instrument-form').style.display = 'none';
      document.getElementById('new-instrument-name').value = '';
    } else {
      alert(data.message);
    }
  });
}
</script>
{% endblock %} 